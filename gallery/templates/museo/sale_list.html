{% extends "museo/base.html" %}
{% load static %}

{% block title %}Sale – Museo{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="text-center mb-4">Sale espositive</h1>

  <!-- GRIGLIA CARD (iniettata da JS in layout 3+2) -->
  <section id="contenitore-sale"></section>

  <!-- PAGINAZIONE STILE TEMI -->
  <div class="pagination-box d-flex flex-column align-items-center gap-2 mt-4">
  <div class="d-flex align-items-center gap-2">
    <button id="precedente-sale" class="btn btn-outline-primary btn-sm">«</button>
    <span>Pagina <strong id="pagina-attuale">1</strong> di <strong id="tot-pagine">1</strong></span>
    <input type="number" min="1" id="salta-pagina"
           class="form-control form-control-sm text-center" style="width: 60px;" />
    <button id="successivo-sale" class="btn btn-outline-primary btn-sm">»</button>
  </div>
</div>



  <!-- MODALE SALA (immutato) -->
  <div class="modal fade" id="salaModal" tabindex="-1" aria-labelledby="salaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="salaModalLabel">Dettaglio sala</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <form id="form-modifica-sala">
            <input type="hidden" id="sala-id">
            <div class="mb-3">
              <label for="sala-nome" class="form-label">Nome sala</label>
              <input type="text" class="form-control" id="sala-nome">
            </div>
            <div class="mb-3">
              <label for="sala-superficie" class="form-label">Superficie (m²)</label>
              <input type="number" class="form-control" id="sala-superficie">
            </div>
            <div class="mb-3">
              <label for="sala-tema" class="form-label">Tema</label>
              <input type="text" class="form-control" id="sala-tema">
            </div>
          </form>

          <hr>

          <h6>Opere esposte</h6>
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Titolo</th>
                <th>Autore</th>
                <th>Tipo</th>
                <th>Anno</th>
              </tr>
            </thead>
            <tbody id="tabella-opere-sala"></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
          <button type="button" class="btn btn-primary" id="salva-modifica-sala">Salva modifiche</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Modale con backdrop trasparente (come temi) */
.modal-backdrop.show { background-color: transparent !important; pointer-events: none !important; }
.modal { z-index: 9999 !important; pointer-events: auto !important; }
.modal-dialog { max-width: 700px; margin-top: 10vh !important; }
.modal-content, .modal-body, .modal-footer, .modal-header { pointer-events: auto !important; position: relative; z-index: 9999; }
.modal label { color: #000 !important; font-weight: 600; }

/* Card quadrate con immagine di sfondo (stile temi) */
.sala-card { position: relative; overflow: hidden; border-radius: 0.75rem; }
.sala-card::before { content: ""; display: block; padding-top: 100%; } /* quadrata */
.sala-card-bg {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  transition: transform .25s ease;
}
.sala-card:hover .sala-card-bg { transform: scale(1.05); }
.sala-card .card-body {
  position: absolute;
  bottom: 0; left: 0; right: 0;
}

/* Overlay informativo */
.sala-overlay {
  position: absolute;
  inset: 0;
  background-color: rgba(0,0,0,0.55);
  color: #fff;
  opacity: 0;
  transform: scale(0.96);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 14px;
  text-align: center;
  font-size: 0.9rem;
  transition: opacity .3s ease, transform .3s ease;
}
.sala-card:hover .sala-overlay { opacity: 1; transform: scale(1); }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const STATIC_IMG_BASE = "{% static 'img_ottimizzate' %}";
const immaginiSale = {
  "Sala 1": "sala1.jpg",
  "Sala 2": "sala2.jpg",
  "Sala 3": "sala3.jpg",
  "Sala 4": "sala4.jpg",
  "Sala 5": "sala5.jpg",
  "Sala 6": "sala6.jpg",
  "Sala 7": "sala7.jpg",
  "Sala 8": "sala8.jpg",
  "Sala 9": "sala9.jpg",
  "Sala 10": "sala10.jpg"
};

function bgSala(sala) {
  const imgFile = immaginiSale[sala.nome] || "default.jpg";
  return `${STATIC_IMG_BASE}/${imgFile}`;
}


/* ========== Stato e avvio ========== */
let tutteLeSale = [];
let paginaCorrente = 1;
const perPagina = 5;
let modal;

$(function () {
  $.getJSON("{% url 'gallery:api_sale_lista' %}", data => {
    tutteLeSale = data || [];
    mostraPagina(1);
  });

  $('#precedente-sale').on('click', () => { if (paginaCorrente > 1) { paginaCorrente--; mostraPagina(paginaCorrente); }});
  $('#successivo-sale').on('click', () => { paginaCorrente++; mostraPagina(paginaCorrente); });
  $('#salta-pagina').on('change', function () {
    const totPagine = Math.ceil(tutteLeSale.length / perPagina) || 1;
    const nuova = parseInt($(this).val(), 10);
    if (nuova >= 1 && nuova <= totPagine) { paginaCorrente = nuova; mostraPagina(paginaCorrente); }
  });

  $('#salva-modifica-sala').on('click', salvaModificaSala);
});

/* ========== Render 3+2 ========== */
function mostraPagina(pagina) {
  const totPagine = Math.ceil(tutteLeSale.length / perPagina) || 1;
  pagina = Math.max(1, Math.min(pagina, totPagine));
  paginaCorrente = pagina;

  const start = (pagina - 1) * perPagina;
  const end = pagina * perPagina;
  const salePagina = tutteLeSale.slice(start, end);

  const $contenitore = $('#contenitore-sale').empty();

  if (!salePagina.length) {
    $contenitore.append('<p class="text-center">Nessuna sala disponibile.</p>');
    aggiornaPaginazione(1, 1);
    return;
  }

  // Prima riga: max 3
  const riga1 = $('<div class="row g-3 justify-content-center mb-3"></div>');
  salePagina.slice(0, 3).forEach(s => riga1.append(creaCardSala(s)));
  $contenitore.append(riga1);

  // Seconda riga: max 2
  const riga2 = $('<div class="row g-3 justify-content-center"></div>');
  salePagina.slice(3, 5).forEach(s => riga2.append(creaCardSala(s)));
  $contenitore.append(riga2);

  aggiornaPaginazione(paginaCorrente, totPagine);
}

function creaCardSala(sala) {
  const superficie = (sala.superficie && sala.superficie !== '0') ? sala.superficie : 'Non definita';
  const tema = sala.tema?.trim() ? sala.tema : 'Non definito';
  const bgUrl = bgSala(sala);

  const $col = $('<div class="col-12 col-sm-6 col-md-4 col-lg-3"></div>');
  const $card = $(`
    <div class="card sala-card shadow-sm border-0 text-white" role="button" aria-label="${sala.nome}">
      <div class="sala-card-bg" style="background-image: url('${bgUrl}');"></div>
      <div class="sala-overlay">
        <div>
          <div><strong>Superficie:</strong> ${superficie} m²</div>
          <div><strong>Tema:</strong> ${tema}</div>
        </div>
      </div>
      <div class="card-body d-flex justify-content-center align-items-center bg-dark bg-opacity-50">
        <h5 class="card-title text-center mb-0">${sala.nome}</h5>
      </div>
    </div>
  `);

  $card.on('click', () => apriPopupSala(sala.numero));
  return $col.append($card);
}

function aggiornaPaginazione(pagina, totPagine) {
  $('#pagina-attuale').text(pagina);
  $('#tot-pagine').text(totPagine);
  $('#salta-pagina').val(pagina);
  $('#precedente-sale').prop('disabled', pagina <= 1);
  $('#successivo-sale').prop('disabled', pagina >= totPagine);
}

/* ========== Modale: lettura & salvataggio ========== */
function apriPopupSala(salaId) {
  $.getJSON(`/api/sale/${salaId}/dettaglio/`, data => {
    $('#sala-id').val(data.numero);
    $('#sala-nome').val(data.nome);
    $('#sala-superficie').val(data.superficie);
    $('#sala-tema').val(data.tema ?? '');

    const $tbody = $('#tabella-opere-sala').empty();
    if (!data.opere || data.opere.length === 0) {
      $tbody.append(`<tr><td colspan="4" class="text-center text-muted">Nessuna opera presente</td></tr>`);
    } else {
      data.opere.slice(0, 5).forEach(opera => {
        $tbody.append(`<tr><td>${opera.titolo}</td><td>${opera.autore}</td><td>${opera.tipo}</td><td>${opera.anno}</td></tr>`);
      });
    }

    modal = new bootstrap.Modal(document.getElementById('salaModal'), { backdrop: true, keyboard: true });
    modal.show();
  });
}

function salvaModificaSala() {
  const payload = {
    numero: $('#sala-id').val(),
    nome: $('#sala-nome').val(),
    superficie: $('#sala-superficie').val(),
    tema: $('#sala-tema').val(),
    csrfmiddlewaretoken: '{{ csrf_token }}'
  };
  $.post('/api/sale/update/', payload, function () {
    modal.hide();
    location.reload();
  }).fail(function (xhr) {
    alert('Errore durante il salvataggio: ' + (xhr.responseJSON?.error || 'errore generico'));
  });
}
</script>
{% endblock %}




