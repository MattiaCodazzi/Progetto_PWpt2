{% extends "museo/base.html" %}
{% load static %}

{% block title %}Elimina opere{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'museo/css/tabella_opere.css' %}">
{% endblock %}

{% block content %}
<h1 class="mb-4">Elimina opere</h1>

<div class="row">
  <!-- ──────────── SIDEBAR FILTRI ──────────── -->
  <aside class="col-md-3 mb-4">
    <h2 class="h5 mb-3">Filtri di ricerca</h2>

    <form id="filtro-opere" class="vstack gap-3">
      <div>
        <label for="titolo" class="form-label">Titolo</label>
        <input type="text" id="titolo" name="titolo" class="form-control">
      </div>

      <div>
        <label for="autoreId" class="form-label">Autore</label>
        <select id="autoreId" name="autoreId" class="form-select">
          <option value="">— Seleziona autore —</option>
        </select>
      </div>

      <div>
        <label for="tipo" class="form-label">Tipo</label>
        <select id="tipo" name="tipo" class="form-select">
          <option value="">— Qualsiasi —</option>
          <option value="Quadro">Quadro</option>
          <option value="Scultura">Scultura</option>
        </select>
      </div>

      <div>
        <label for="salaId" class="form-label">Sala</label>
        <select id="salaId" name="salaId" class="form-select">
          <option value="">— Qualsiasi —</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">Cerca</button>
    </form>

    <div id="messaggio-inserimento" class="mt-3"></div>
  </aside>

  <!-- ──────────── RISULTATI & AZIONI ──────────── -->
  <section class="col-md-9">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 mb-0">Risultati</h2>
      <button id="elimina-selezionate" class="btn btn-danger">
        Elimina selezionate
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tabella-opere">
        <thead class="table-light">
          <tr>
            <th style="width:40px">
              <input type="checkbox" id="seleziona-tutte">
            </th>
            <th>Titolo</th>
            <th>Autore</th>
            <th>Tipo</th>
            <th>Anno&nbsp;real.</th>
            <th>Anno&nbsp;acq.</th>
            <th>Sala</th>
          </tr>
        </thead>
        <tbody id="corpo-tabella-opere"></tbody>
      </table>
    </div>

    <nav id="paginazione" class="d-flex justify-content-center mt-3"></nav>
    <div id="messaggio" class="mt-3"></div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
/* =====================================================================
   End-point da predisporre in urls.py → views / DRF:
     - api_autori_lista        (GET)
     - api_sale_lista          (GET)
     - api_opere_delete_search (POST  → filtri, paginazione)
     - api_opere_delete        (POST  → elimina elenco codici)
   ===================================================================== */

$(function () {

  /* ---- popola select Autori ---- */
  $.getJSON("{% url 'api_autori_lista' %}", data => {
    data.forEach(a =>
      $('#autoreId').append(`<option value="${a.codice}">${a.nome} ${a.cognome}</option>`)
    );
  });

  /* ---- popola select Sale ---- */
  $.getJSON("{% url 'api_sale_lista' %}", data => {
    data.forEach(s =>
      $('#salaId').append(`<option value="${s.numero}">${s.nome}</option>`)
    );
  });

  /* ---- caricamento iniziale ---- */
  caricaOpere({}, 1);

  /* ---- submit filtri ---- */
  $('#filtro-opere').on('submit', function (e) {
    e.preventDefault();
    caricaOpere(raccogliFiltri(), 1);
  });

  /* ---- paginatore ---- */
  $('#paginazione').on('click', '.pagina', function () {
    caricaOpere(raccogliFiltri(), $(this).data('pagina'));
  });

  /* ---- select all ---- */
  $('#seleziona-tutte').on('change', function () {
    $('.seleziona-opera').prop('checked', this.checked);
  });

  /* ---- elimina selezionate ---- */
  $('#elimina-selezionate').on('click', function () {
    const codici = $('.seleziona-opera:checked').map((_, el) => el.value).get();
    if (!codici.length) {
      alert("Seleziona almeno un'opera da eliminare.");
      return;
    }
    if (!confirm(`Eliminare ${codici.length} opera/e?`)) return;

    $.post("{% url 'api_opere_delete' %}", { codici }, res => {
      $('#messaggio').html(`<div class="alert alert-success">${res.msg}</div>`);
      caricaOpere(raccogliFiltri(), 1);
    }, 'json').fail(xhr => {
      const err = xhr.responseJSON?.error || 'Errore.';
      $('#messaggio').html(`<div class="alert alert-danger">${err}</div>`);
    });
  });

});

/* ===== helper per filtri ===== */
function raccogliFiltri() {
  return {
    titolo:   $('#titolo').val(),
    autoreId: $('#autoreId').val(),
    tipo:     $('#tipo').val(),
    salaId:   $('#salaId').val() || null
  };
}

/* ===== carica opere + render ===== */
function caricaOpere(filtri, pagina = 1) {
  filtri.pagina = pagina;

  $.post("{% url 'api_opere_delete_search' %}", filtri, res => {
    const { opere, totale, limite } = res;
    const totPagine = Math.ceil(totale / limite);
    const $tbody = $('#corpo-tabella-opere').empty();

    if (!opere.length) {
      $tbody.append('<tr><td colspan="7" class="text-center">Nessun risultato.</td></tr>');
    } else {
      opere.forEach(o => {
        $tbody.append(`
          <tr>
            <td><input type="checkbox" class="form-check-input seleziona-opera" value="${o.codice}"></td>
            <td>${o.titolo}</td>
            <td>${o.autore}</td>
            <td>${o.tipo}</td>
            <td>${o.annoRealizzazione}</td>
            <td>${o.annoAcquisto}</td>
            <td>${o.sala ?? '—'}</td>
          </tr>`);
      });
    }

    /* ---------- paginazione ---------- */
    const $pag = $('#paginazione').empty();
    if (totPagine > 1) {
      if (pagina > 1) $pag.append(`<button class="btn btn-outline-secondary me-2 pagina" data-pagina="${pagina-1}">«</button>`);
      $pag.append(`<span class="fw-semibold">Pagina ${pagina} / ${totPagine}</span>`);
      if (pagina < totPagine) $pag.append(`<button class="btn btn-outline-secondary ms-2 pagina" data-pagina="${pagina+1}">»</button>`);
    }
  }, 'json').fail(() => alert("Errore nel caricamento delle opere."));
}
</script>
{% endblock %}
