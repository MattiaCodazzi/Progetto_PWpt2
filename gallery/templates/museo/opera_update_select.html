{% extends "museo/base.html" %}
{% load static %}

{% block title %}Modifica opere{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'museo/css/tabella_opere.css' %}">
{% endblock %}

{% block content %}
<h1 class="mb-4">Modifica opere</h1>

<div class="row">
  <!-- ──────────────── FILTRI ──────────────── -->
  <aside class="col-md-3 mb-4">
    <h2 class="h5 mb-3">Filtri di ricerca</h2>

    <form id="filtro-opere" class="vstack gap-3">
      <div>
        <label for="titolo" class="form-label">Titolo</label>
        <input type="text" id="titolo" name="titolo" class="form-control">
      </div>

      <div>
        <label for="autoreId" class="form-label">Autore</label>
        <select id="autoreId" name="autoreId" class="form-select">
          <option value="">— Seleziona autore —</option>
        </select>
      </div>

      <div>
        <label for="tipo" class="form-label">Tipo</label>
        <select id="tipo" name="tipo" class="form-select">
          <option value="">— Qualsiasi —</option>
          <option value="Quadro">Quadro</option>
          <option value="Scultura">Scultura</option>
        </select>
      </div>

      <div>
        <label for="salaId" class="form-label">Sala</label>
        <select id="salaId" name="salaId" class="form-select">
          <option value="">— Qualsiasi —</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">Cerca</button>
    </form>
  </aside>

  <!-- ───────────── RISULTATI & FORM ───────────── -->
  <section class="col-md-9">
    <div class="table-responsive mb-3">
      <table id="tabella-opere" class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Titolo</th>
            <th>Autore</th>
            <th>Tipo</th>
            <th>Anno&nbsp;real.</th>
            <th>Anno&nbsp;acq.</th>
            <th>Sala</th>
          </tr>
        </thead>
        <tbody id="corpo-tabella-opere"></tbody>
      </table>
    </div>
    <nav id="paginazione" class="d-flex justify-content-center mb-4"></nav>

    <!-- form di modifica (iniettato via JS) -->
    <div id="form-modifica-wrapper"></div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
/* =====================================================================
   Endpoint (stub) già presenti in gallery/urls.py → api_views.py
     • gallery:api_autori_lista
     • gallery:api_sale_lista
     • gallery:api_opere_update_search
     • gallery:api_opera_get
     • gallery:api_opera_update
   ===================================================================== */

$(function () {
  /* -------- Popola select Autori -------- */
  $.getJSON("{% url 'gallery:api_autori_lista' %}", data => {
    data.forEach(a =>
      $('#autoreId').append(`<option value="${a.codice}">${a.nome} ${a.cognome}</option>`));
  });

  /* -------- Popola select Sale -------- */
  $.getJSON("{% url 'gallery:api_sale_lista' %}", data => {
    data.forEach(s =>
      $('#salaId').append(`<option value="${s.numero}">${s.nome}</option>`));
  });

  /* -------- Caricamento iniziale -------- */
  caricaOpere({}, 1);

  $('#filtro-opere').on('submit', function (e) {
    e.preventDefault();
    caricaOpere(raccogliFiltri(), 1);
  });

  $('#paginazione').on('click', '.pagina', function () {
    caricaOpere(raccogliFiltri(), $(this).data('pagina'));
  });

  $('#corpo-tabella-opere').on('click', 'tr', function () {
    const codice = $(this).data('id');
    caricaForm(codice);
  });
});

/* ===== Helpers ===== */
function raccogliFiltri() {
  return {
    titolo:   $('#titolo').val(),
    autoreId: $('#autoreId').val(),
    tipo:     $('#tipo').val(),
    salaId:   $('#salaId').val() || null
  };
}

/* ===== Carica opere + paginazione ===== */
function caricaOpere(filtri, pagina = 1) {
  filtri.pagina = pagina;

  $.post("{% url 'gallery:api_opere_update_search' %}", filtri, res => {
    const { opere, totale, limite } = res;
    const totPagine = Math.ceil(totale / limite);
    const $tbody = $('#corpo-tabella-opere').empty();

    if (!opere.length) {
      $tbody.append('<tr><td colspan="6" class="text-center">Nessun risultato.</td></tr>');
    } else {
      opere.forEach(o => {
        $tbody.append(`
          <tr data-id="${o.codice}" style="cursor:pointer">
            <td>${o.titolo}</td>
            <td>${o.autore}</td>
            <td>${o.tipo}</td>
            <td>${o.annoRealizzazione}</td>
            <td>${o.annoAcquisto}</td>
            <td>${o.sala ?? '—'}</td>
          </tr>`);
      });
    }

    const $pag = $('#paginazione').empty();
    if (totPagine > 1) {
      if (pagina > 1) $pag.append(`<button class="btn btn-outline-secondary me-2 pagina" data-pagina="${pagina-1}">«</button>`);
      $pag.append(`<span class="fw-semibold">Pagina ${pagina} / ${totPagine}</span>`);
      if (pagina < totPagine) $pag.append(`<button class="btn btn-outline-secondary ms-2 pagina" data-pagina="${pagina+1}">»</button>`);
    }
  }, 'json').fail(() => alert("Errore nel caricamento delle opere."));
}

/* ===== Carica form di modifica ===== */
function caricaForm(codice) {
  $.getJSON("{% url 'gallery:api_opera_get' %}?codice=" + codice, opera => {

    const template = `
      <h2 class="h5 mb-3">Modifica opera</h2>
      <form id="modifica-opera" class="row g-3">
        <input type="hidden" name="codice" value="${opera.codice}">
        <div class="col-md-6">
          <label class="form-label">Titolo</label>
          <input name="titolo" class="form-control" type="text" value="${opera.titolo ?? ''}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Anno real.</label>
          <input name="annoRealizzazione" class="form-control" type="number" value="${opera.annoRealizzazione ?? ''}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Anno acq.</label>
          <input name="annoAcquisto" class="form-control" type="number" value="${opera.annoAcquisto ?? ''}" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Tipo</label>
          <select name="tipo" class="form-select" required>
            <option value="Quadro"   ${opera.tipo === 'Quadro'   ? 'selected' : ''}>Quadro</option>
            <option value="Scultura" ${opera.tipo === 'Scultura' ? 'selected' : ''}>Scultura</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Sala</label>
          <input name="espostaInSala" class="form-control" type="number" value="${opera.espostaInSala ?? ''}">
        </div>
        <div class="col-12">
          <button class="btn btn-success">Salva modifiche</button>
          <button type="button" class="btn btn-outline-secondary ms-2" id="annulla-modifica">Annulla</button>
        </div>
      </form>
      <div id="messaggio-modifica" class="mt-3"></div>
    `;

    $('#form-modifica-wrapper').html(template).scrollTop();

    $('#modifica-opera').on('submit', function (e) {
      e.preventDefault();
      $.post("{% url 'gallery:api_opera_update' %}", $(this).serialize(), res => {
        $('#messaggio-modifica').html(`<div class="alert alert-success">${res.msg}</div>`);
        caricaOpere(raccogliFiltri(), 1);
      }, 'json').fail(xhr => {
        const err = xhr.responseJSON?.error || 'Errore.';
        $('#messaggio-modifica').html(`<div class="alert alert-danger">${err}</div>`);
      });
    });

    $('#annulla-modifica').on('click', () => $('#form-modifica-wrapper').empty());
  }).fail(() => alert(\"Impossibile caricare l’opera selezionata.\"));\n}\n</script>\n{% endblock %}"}]}

