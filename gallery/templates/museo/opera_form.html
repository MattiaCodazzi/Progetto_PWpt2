{% extends "museo/base.html" %}
{% load static %}

{% block title %}Gestione opere{% endblock %}

{% block extra_head %}
<link href="{% static 'museo/css/tabella_opere.css' %}" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="row">
<aside class="col-md-4 mb-4">
<h2 class="h5 mb-3" id="form-title">Inserisci o cerca opera</h2>
<form class="vstack gap-3" id="form-opera">
<input id="codice" name="codice" type="hidden"/>
<div>
<label class="form-label" for="autoreId">Autore</label>
<select class="form-select" id="autoreId" name="autore">
<option value="">— Qualsiasi autore —</option>
</select>
</div>
<div>
<label class="form-label" for="titolo">Titolo</label>
<input class="form-control" id="titolo" name="titolo" type="text"/>
</div>
<div>
<label class="form-label" for="annoRealizzazioneMin">Anno di realizzazione (da - a)</label>
<div class="d-flex gap-2">
<input class="form-control" id="annoRealizzazioneMin" name="annoRealizzazioneMin" placeholder="min" type="number"/>
<input class="form-control" id="annoRealizzazioneMax" name="annoRealizzazioneMax" placeholder="max" type="number"/>
</div>
</div>
<div>
<label class="form-label" for="annoAcquistoMin">Anno di acquisto (da - a)</label>
<div class="d-flex gap-2">
<input class="form-control" id="annoAcquistoMin" name="annoAcquistoMin" placeholder="min" type="number"/>
<input class="form-control" id="annoAcquistoMax" name="annoAcquistoMax" placeholder="max" type="number"/>
</div>
</div>
<div id="blocco-anno-acquisto">
<label class="form-label" for="annoAcquisto">Anno di acquisto</label>
<input class="form-control" id="annoAcquisto" name="annoAcquisto" type="number"/>
</div><div id="blocco-anno-realizzazione">
<label class="form-label" for="annoRealizzazione">Anno di realizzazione</label>
<input class="form-control" id="annoRealizzazione" name="annoRealizzazione" type="number"/>
</div><div>
<label class="form-label" for="tipo">Tipo</label>
<select class="form-select" id="tipo" name="tipo">
<option value="">— Qualsiasi tipo —</option>
<option value="Quadro">Quadro</option>
<option value="Scultura">Scultura</option>
</select>
</div>
<div>
<label class="form-label" for="espostaInSalaId">Sala (opzionale)</label>
<select class="form-select" id="espostaInSalaId" name="sala">
<option value="">— Nessuna —</option>
</select>
</div>
<div class="d-flex gap-2">
<button class="btn btn-success w-100" id="btn-cerca" type="button">Cerca</button>
<button class="btn btn-primary w-100" id="btn-inserisci" type="submit">Inserisci</button>
</div>
<button class="btn btn-secondary d-none" id="btn-cancel" type="button">Annulla modifica</button>
</form>
<div class="mt-3" id="messaggio"></div>
</aside>
<section class="col-md-8">
<h2 class="h5 mb-3">Risultati</h2>
<div class="d-flex justify-content-between align-items-center mb-2">
<button class="btn btn-danger btn-sm" id="elimina-selezionate">Elimina selezionate</button>
<nav class="d-flex" id="paginazione"></nav>
</div>
<div class="table-responsive">
<table class="table table-striped align-middle" id="tabella-opere">
<thead class="table-light">
<tr>
<th><input id="seleziona-tutte" type="checkbox"/></th>
<th>Titolo</th>
<th>Autore</th>
<th>Tipo</th>
<th>Anno real.</th>
<th>Anno acq.</th>
<th>Sala</th>
</tr>
</thead>
<tbody id="corpo-tabella-opere"></tbody>
</table>
</div>
</section>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js">

function entraInModalitaModifica() {
  $('#annoRealizzazioneMin, #annoRealizzazioneMax, #annoAcquistoMin, #annoAcquistoMax').closest('.d-flex').parent().hide();
  $('#blocco-anno-realizzazione, #blocco-anno-acquisto').show();
}

function esciDaModalitaModifica() {
  $('#annoRealizzazioneMin, #annoRealizzazioneMax, #annoAcquistoMin, #annoAcquistoMax').closest('.d-flex').parent().show();
  $('#blocco-anno-realizzazione, #blocco-anno-acquisto').hide();
}
$(document).ready(function() {
  esciDaModalitaModifica(); // di default mostra i range
});

</script>
<script>
$(function () {
  // Popola select autore e sala
  $.getJSON("{% url 'gallery:api_autori_lista' %}", data => {
    data.forEach(a => {
      $('#autoreId').append(`<option value="${a.codice}">${a.cognome} ${a.nome}</option>`);
    });
  });
  $.getJSON("{% url 'gallery:api_sale_lista' %}", data => {
    data.forEach(s => {
      $('#espostaInSalaId').append(`<option value="${s.numero}">${s.nome}</option>`);
    });
  });

  caricaOpere({}, 1);

  $('#seleziona-tutte').on('change', function () {
    $('.seleziona-opera').prop('checked', this.checked);
  });

  $('#btn-cerca').on('click', function () {
    caricaOpere(raccogliFiltri(), 1);
  });

  $('#form-opera').on('submit', function (e) {
    const real = parseInt($('#annoRealizzazione').val(), 10);
    const acq = parseInt($('#annoAcquisto').val(), 10);
    if (!isNaN(real) && !isNaN(acq) && acq < real) {
      e.preventDefault();
      $('#messaggio').html('<div class="alert alert-danger">L\'anno di acquisto non può precedere quello di realizzazione.</div>');
      return;
    }

    e.preventDefault();
    const url = $('#codice').val() ? "{% url 'gallery:api_opera_update' %}" : "{% url 'gallery:api_opera_create' %}";
    $.post(url, $(this).serialize())
      .done(res => {
        $('#messaggio').html(`<div class="alert alert-success">${res.msg}</div>`);
        this.reset();
        $('#btn-cancel').addClass('d-none');
        $('#form-title').text("Inserisci o cerca opera");
        $('#btn-inserisci').text("Inserisci");
        caricaOpere({}, 1);
      })
      .fail(xhr => {
        const err = xhr.responseJSON?.error || 'Errore.';
        $('#messaggio').html(`<div class="alert alert-danger">${err}</div>`);
      });
  });

  $('#btn-cancel').on('click', function () {
    $('#form-opera')[0].reset();
    $('#codice').val('');
    $('#btn-inserisci').text("Inserisci");
    $('#form-title').text("Inserisci o cerca opera");
    $(this).addClass('d-none');
  });

  $('#elimina-selezionate').on('click', function () {
    const codici = $('.seleziona-opera:checked').map((_, el) => el.value).get();
    if (!codici.length) return alert("Seleziona almeno un'opera da eliminare.");
    if (!confirm(`Confermi l'eliminazione di ${codici.length} opera/e?`)) return;
    $.post("{% url 'gallery:api_opere_delete' %}", { codici }, res => {
      $('#messaggio').html(`<div class="alert alert-success">${res.msg}</div>`);
      caricaOpere({}, 1);
    });
  });

  $('#corpo-tabella-opere').on('click', 'tr', function () {
    const id = $(this).data('id');
    $.getJSON("{% url 'gallery:api_opera_get' %}?codice=" + id, opera => {
      $('#codice').val(opera.codice);
      $('#titolo').val(opera.titolo);
      $('#annoRealizzazione').val(opera.annoRealizzazione);
      $('#annoAcquisto').val(opera.annoAcquisto);
      $('#autoreId').val(opera.autoreId);
      $('#espostaInSalaId').val(opera.espostaInSala);
      $('#tipo').val(opera.tipo);
      $('#btn-inserisci').text("Salva modifiche");
      $('#btn-cancel').removeClass("d-none");
      $('#form-title').text("Modifica opera");
    });
  });
});

function raccogliFiltri() {
  const realMin = $('#annoRealizzazioneMin').val();
  const realMax = $('#annoRealizzazioneMax').val();
  const acqMin = $('#annoAcquistoMin').val();
  const acqMax = $('#annoAcquistoMax').val();
  return {
    annoRealizzazioneMin: realMin,
    annoRealizzazioneMax: realMax,
    annoAcquistoMin: acqMin,
    annoAcquistoMax: acqMax,
    titolo: $('#titolo').val(),
    autore: $('#autoreId').val(),
    tipo: $('#tipo').val(),
    annoRealizzazione: $('#annoRealizzazione').val(),
    annoAcquisto: $('#annoAcquisto').val(),
    salaId: $('#espostaInSalaId').val()
  };
}

function caricaOpere(filtri, pagina = 1) {
  filtri.pagina = pagina;
  $.post("{% url 'gallery:api_opere_search' %}", filtri, res => {
    const { opere, totale, limite } = res;
    const $tbody = $('#corpo-tabella-opere').empty();
    if (!opere.length) {
      $tbody.append('<tr><td colspan="7" class="text-center">Nessun risultato.</td></tr>');
    } else {
      opere.forEach(o => {
        $tbody.append(`
          <tr data-id="${o.codice}" style="cursor:pointer;">
            <td><input type="checkbox" class="form-check-input seleziona-opera" value="${o.codice}"></td>
            <td>${o.titolo}</td>
            <td>${o.autore}</td>
            <td>${o.tipo}</td>
            <td>${o.annoRealizzazione}</td>
            <td>${o.annoAcquisto}</td>
            <td>${o.sala ?? '—'}</td>
          </tr>
        `);
      });
    }
  });
}
</script>
{% endblock %}

