{% extends "museo/base.html" %}
{% load static %}

{% block title %}Cerca opere{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'museo/css/tabella_opere.css' %}">
{% endblock %}

{% block content %}
<h1 class="mb-4">Cerca opere</h1>

<div class="row">
  <!-- ──────────── SIDEBAR FILTRI ──────────── -->
  <aside class="col-md-3 mb-4">
    <h2 class="h5 mb-3">Filtri di ricerca</h2>
    <form id="filtro-opere" class="vstack gap-3">
      <div>
        <label for="titolo" class="form-label">Titolo</label>
        <input type="text" id="titolo" name="titolo" class="form-control">
      </div>

      <div>
        <label for="autoreId" class="form-label">Autore</label>
        <select id="autoreId" name="autoreId" class="form-select">
          <option value="">— Seleziona autore —</option>
        </select>
      </div>

      <div>
        <label for="tipo" class="form-label">Tipo</label>
        <select id="tipo" name="tipo" class="form-select">
          <option value="">— Qualsiasi —</option>
          <option value="Quadro">Quadro</option>
          <option value="Scultura">Scultura</option>
        </select>
      </div>

      <div>
        <label for="salaId" class="form-label">Sala</label>
        <select id="salaId" name="salaId" class="form-select">
          <option value="">— Qualsiasi —</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">Cerca</button>
    </form>
  </aside>

  <!-- ──────────── RISULTATI ──────────── -->
  <section class="col-md-9">
    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tabella-opere">
        <thead class="table-light">
          <tr>
            <th>Titolo</th>
            <th>Autore</th>
            <th>Tipo</th>
            <th>Anno real.</th>
            <th>Anno acquisto</th>
            <th>Sala</th>
          </tr>
        </thead>
        <tbody id="corpo-tabella-opere"></tbody>
      </table>
    </div>

    <nav id="paginazione" class="d-flex justify-content-center mt-3"></nav>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
/* =====================================================================
   End‑point da predisporre:
     - gallery:api_autori_lista   (GET)
     - gallery:api_sale_lista     (GET)
     - gallery:api_opere_search   (POST)
===================================================================== */
$(function () {
  /* ---------- Popola select autori ---------- */
  $.getJSON("{% url 'gallery:api_autori_lista' %}", data => {
    data.forEach(a =>
      $('#autoreId').append(`<option value="${a.codice}">${a.nome} ${a.cognome}</option>`)
    );
  });

  /* ---------- Popola select sale ---------- */
  $.getJSON("{% url 'gallery:api_sale_lista' %}", data => {
    data.forEach(s =>
      $('#salaId').append(`<option value="${s.numero}">${s.nome}</option>`)
    );
  });

  /* ---------- Caricamento iniziale ---------- */
  caricaOpere({}, 1);

  $('#filtro-opere').on('submit', function (e) {
    e.preventDefault();
    caricaOpere(raccogliFiltri(), 1);
  });

  $('#paginazione').on('click', '.pagina', function () {
    caricaOpere(raccogliFiltri(), $(this).data('pagina'));
  });
});

function raccogliFiltri() {
  return {
    titolo:   $('#titolo').val(),
    autoreId: $('#autoreId').val(),
    tipo:     $('#tipo').val(),
    salaId:   $('#salaId').val() || null
  };
}

function caricaOpere(filtri, pagina = 1) {
  filtri.pagina = pagina;

  $.post("{% url 'gallery:api_opere_search' %}", filtri, function (response) {
    const { opere, totale, limite } = response;
    const totPagine = Math.ceil(totale / limite);
    const $tbody = $('#corpo-tabella-opere').empty();

    if (!opere.length) {
      $tbody.append('<tr><td colspan="6" class="text-center">Nessun risultato trovato.</td></tr>');
    } else {
      opere.forEach(o => {
        $tbody.append(`
          <tr>
            <td>${o.titolo}</td>
            <td>${o.autore}</td>
            <td>${o.tipo}</td>
            <td>${o.annoRealizzazione}</td>
            <td>${o.annoAcquisto}</td>
            <td>${o.sala ?? '—'}</td>
          </tr>`);
      });
    }

    const $pag = $('#paginazione').empty();
    if (totPagine > 1) {
      if (pagina > 1) $pag.append(`<button class="btn btn-outline-secondary me-2 pagina" data-pagina="${pagina-1}">«</button>`);
      $pag.append(`<span class="fw-semibold">Pagina ${pagina} / ${totPagine}</span>`);
      if (pagina < totPagine) $pag.append(`<button class="btn btn-outline-secondary ms-2 pagina" data-pagina="${pagina+1}">»</button>`);
    }
  }, 'json').fail(() => alert("Errore nel caricamento delle opere."));
}
</script>
{% endblock %}

