{% extends "museo/base.html" %}
{% load static %}

{% block title %}Gestione autori{% endblock %}

{% block extra_head %}
<link href="{% static 'museo/css/tabella_opere.css' %}" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="row">
  <aside class="col-md-4 mb-4">
    <h2 class="h5 mb-3" id="form-title">Inserisci o cerca autore</h2>
    <form class="vstack gap-3" id="form-autore">
      <input id="codice" name="codice" type="hidden"/>

      <div>
        <label class="form-label" for="nomeCompleto">Autore</label>
        <input class="form-control" id="nomeCompleto" name="nomeCompleto" type="text" placeholder="Mario Rossi" />
      </div>

      <div>
        <label class="form-label" for="nazione">Nazione</label>
        <input class="form-control" id="nazione" name="nazione" type="text" />
      </div>

      <div>
        <label class="form-label" for="dataNascita">Data di nascita</label>
        <input class="form-control" id="dataNascita" name="dataNascita" type="date" />
      </div>

      <div>
        <label class="form-label" for="periodo">Periodo</label>
        <div class="d-flex gap-2">
          <input class="form-control" id="periodomin" placeholder="min" type="number"/>
          <input class="form-control" id="periodomax" placeholder="max" type="number"/>
        </div>
      </div>

      <div>
        <label class="form-label">Stato</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="tipo" id="tipo_tutti" value="" checked>
          <label class="form-check-label" for="tipo_tutti">Tutti</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="tipo" id="tipo_vivo" value="vivo">
          <label class="form-check-label" for="tipo_vivo">Vivo</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="tipo" id="tipo_morto" value="morto">
          <label class="form-check-label" for="tipo_morto">Morto</label>
        </div>
      </div>

      <div>
        <label class="form-label" for="dataMorte">Data di morte</label>
        <input class="form-control" id="dataMorte" name="dataMorte" type="date" />
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success w-100" id="btn-cerca" type="button">Cerca</button>
        <button class="btn btn-primary w-100" id="btn-inserisci" type="submit">Inserisci</button>
      </div>
      <button class="btn btn-secondary d-none" id="btn-cancel" type="button">Annulla modifica</button>
    </form>

    <div class="mt-3" id="messaggio"></div>
  </aside>

  <section class="col-md-8">
    <h2 class="h5 mb-3">Risultati</h2>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <button class="btn btn-danger btn-sm" id="elimina-selezionate" type="button">Elimina selezionate</button>
      <div id="conferma-eliminazione" class="alert alert-warning d-none mt-2">
        <span id="testo-conferma"></span>
        <div class="mt-2">
          <button class="btn btn-danger btn-sm me-2" id="btn-conferma-elimina" type="button">Conferma</button>
          <button class="btn btn-secondary btn-sm" id="btn-annulla-elimina" type="button">Annulla</button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tabella-opere">
        <thead class="table-light">
          <tr>
            <th><input class="form-check-input" type="checkbox"></th>
            <th>Nome</th>
            <th>Cognome</th>
            <th>Nazione</th>
            <th>Nascita</th>
            <th>Stato</th>
            <th>Morte</th>
          </tr>
        </thead>
        <tbody id="corpo-tabella-opere"></tbody>
      </table>
      <nav class="d-flex justify-content-center align-items-center gap-2 mt-3" id="paginazione">
        <!-- Paginazione dinamica -->
      </nav>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// --- Formatter date IT ---
function parseISODateOnly(iso) {
  if (!iso) return null;
  const p = iso.split('-').map(Number);
  if (p.length !== 3) return null;
  return new Date(p[0], p[1]-1, p[2]); // Data locale senza timezone shift
}
function formatDateIT(iso, style = 'short') {
  const d = parseISODateOnly(iso);
  if (!d || Number.isNaN(d)) return '—';
  const opts = (style === 'short')
    ? { day:'2-digit', month:'2-digit', year:'numeric' }      // 31/12/2025
    : { day:'numeric', month:'long', year:'numeric' };        // 31 dicembre 2025
  return new Intl.DateTimeFormat('it-IT', opts).format(d);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

$.ajaxSetup({
  beforeSend: function (xhr, settings) {
    if (!/^((GET|HEAD|OPTIONS|TRACE))$/i.test(settings.type)) {
      xhr.setRequestHeader("X-CSRFToken", csrftoken);
    }
  }
});

$(function () {
  const form = $('#form-autore');
  const tableBody = $('#corpo-tabella-opere');
  const paginazione = $('#paginazione');
  let paginaCorrente = 1;

  // --- Messaggi a tempo (5s) ---
  const MSG_TIMEOUT = 5000;
  let _msgTimer = null;
  let _confirmTimer = null;

  function flashMessage(html) {
    const $m = $('#messaggio');
    $m.stop(true, true).hide().html(html).fadeIn(120);
    clearTimeout(_msgTimer);
    _msgTimer = setTimeout(() => {
      $m.fadeOut(200, () => $m.empty().show());
    }, MSG_TIMEOUT);
  }

  function showConfirmBox() {
    const $c = $('#conferma-eliminazione');
    $c.removeClass('d-none');
    clearTimeout(_confirmTimer);
    _confirmTimer = setTimeout(() => {
      hideConfirmBox();
      flashMessage('<div class="alert alert-info">Operazione annullata: tempo scaduto.</div>');
    }, MSG_TIMEOUT);
  }

  function hideConfirmBox() {
    $('#conferma-eliminazione').addClass('d-none');
    clearTimeout(_confirmTimer);
  }

  function aggiornaTabella(filtri = {}) {
    filtri.pagina = paginaCorrente;
    filtri.limite = 10;

    $.post("/api/autori/search/form/", filtri, function (data) {
      const autori = data.risultati || [];
      const totale = data.totale || autori.length;
      const limite = data.limite || 10;
      const pagineTotali = Math.ceil(totale / limite);

      tableBody.empty();

      if (!autori.length) {
        tableBody.append('<tr><td colspan="7" class="text-center">Nessun autore trovato.</td></tr>');
        paginazione.empty();
        return;
      }

      autori.forEach(a => {
        tableBody.append(`
          <tr style="cursor:pointer;"
              data-codice="${a.codice}"
              data-nome="${a.nome}"
              data-cognome="${a.cognome}"
              data-nazione="${a.nazione}"
              data-datanascita="${a.dataNascita}"
              data-datamorte="${a.dataMorte}"
              data-tipo="${a.tipo}">
            <td><input class="form-check-input seleziona-autore" type="checkbox" value="${a.codice}" /></td>
            <td><a href="/autori/${a.codice}/">${a.nome}</a></td>
            <td>${a.cognome}</td>
            <td>${a.nazione}</td>
            <td class="text-end">${formatDateIT(a.dataNascita)}</td>
            <td>${a.tipo}</td>
            <td class="text-end">${formatDateIT(a.dataMorte)}</td>
          </tr>
        `);
      });

      paginazione.empty();
      for (let i = 1; i <= pagineTotali; i++) {
        const active = i === paginaCorrente ? 'active' : '';
        paginazione.append(`<button type="button" class="btn btn-sm btn-outline-primary ${active}" data-pagina="${i}">${i}</button>`);
      }
    });
  }

  paginazione.on('click', 'button[data-pagina]', function () {
    paginaCorrente = parseInt($(this).data('pagina'));
    aggiornaTabella(form.serializeObject());
  });

  aggiornaTabella();

  $('#btn-cerca').on('click', function () {
    paginaCorrente = 1;
    aggiornaTabella(form.serializeObject());
  });

  form.on('submit', function (e) {
    e.preventDefault();

    // Nome completo -> nome + cognome
    const nomeCompleto = $('#nomeCompleto').val().trim();
    const [nome, ...resto] = nomeCompleto.split(' ');
    const cognome = (resto.join(' ')).trim();

    const dati = form.serializeObject();
    dati.nome = nome || '';
    dati.cognome = cognome || '';

    const codice = $('#codice').val();
    const url = codice ? "/api/autori/update/" : "/api/autore/create/";

    $.post(url, dati)
      .done(() => {
        form[0].reset();
        $('#codice').val('');
        $('#btn-cancel').addClass('d-none');
        $('#btn-inserisci').text('Inserisci');
        aggiornaTabella();
        // (Se vuoi un messaggio di conferma anche qui, scommenta la riga sotto)
        // flashMessage('<div class="alert alert-success">Operazione completata correttamente.</div>');
      })
      .fail(function (xhr) {
        const errore = xhr.responseJSON?.error || "Errore durante la modifica.";
        flashMessage(`<div class="alert alert-danger">${errore}</div>`);
      });
  });

  tableBody.on('click', 'tr', function () {
    const r = $(this).data();

    $('#codice').val(r.codice);
    $('#nomeCompleto').val(`${r.nome} ${r.cognome}`.trim());
    $('#nazione').val(r.nazione || '');
    $('#dataNascita').val(r.datanascita || '');
    $('#dataMorte').val(r.datamorte || '');
    // Se hai radio "tipo", puoi selezionare quello giusto così:
    if (r.tipo) {
      $(`input[name="tipo"][value="${r.tipo}"]`).prop('checked', true);
    }

    $('#btn-cancel').removeClass('d-none');
    $('#btn-inserisci').text('Salva modifiche');
  });

  $('#btn-cancel').on('click', function () {
    form[0].reset();
    $('#codice').val('');
    $(this).addClass('d-none');
    $('#btn-inserisci').text('Inserisci');
  });

  $('#elimina-selezionate').on('click', function () {
    const selezionati = $('#corpo-tabella-opere input[type="checkbox"]:checked')
      .map(function () { return $(this).val(); }).get();

    if (!selezionati.length) {
      flashMessage('<div class="alert alert-danger">Nessun autore selezionato.</div>');
      return;
    }

    $('#testo-conferma').text(`Confermare eliminazione di ${selezionati.length} autore/i?`);
    showConfirmBox();

    $('#btn-conferma-elimina').off().on('click', function () {
      $.post("/api/autori/delete/", { "codici[]": selezionati })
        .done(() => {
          hideConfirmBox();
          aggiornaTabella();
          flashMessage('<div class="alert alert-success">Autori eliminati correttamente.</div>');
        })
        .fail(() => {
          hideConfirmBox();
          flashMessage('<div class="alert alert-danger">Errore durante l\'eliminazione.</div>');
        });
    });

    $('#btn-annulla-elimina').off().on('click', function () {
      hideConfirmBox();
    });
  });

  // Helper per serializzare in oggetto
  $.fn.serializeObject = function () {
    const o = {};
    const a = this.serializeArray();
    $.each(a, function () {
      if (o[this.name]) {
        if (!Array.isArray(o[this.name])) {
          o[this.name] = [o[this.name]];
        }
        o[this.name].push(this.value || '');
      } else {
        o[this.name] = this.value || '';
      }
    });
    return o;
  };
});
</script>
{% endblock %}
